# –í–ê–ñ–ù–û: –¢—Ä–µ–±—É—é—Ç—Å—è —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–∞–º –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏–π **–í–†–£–ß–ù–£–Æ**:

## 1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS (Infinite Recursion)

**–ü—Ä–æ–±–ª–µ–º–∞:** `infinite recursion detected in policy for relation "users"`

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `database/PRODUCTION_SECURE_RLS_FIXED.sql`
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `FIX_INFINITE_RECURSION.md`

---

## 2. üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –ë–î

**–¢–∞–±–ª–∏—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:**
- `applications` - —Å–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- `admin_votes` - –≥–æ–ª–æ—Å–∞ –∞–¥–º–∏–Ω–æ–≤
- `audit_errors` - –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
- `email_verification_codes` - –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ 6-digit –∫–æ–¥—ã)

**–ü–æ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:**
- `users.allergies_description` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `users.password_hash` - –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (–æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤)

**–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `database/CLEANUP_UNUSED_TABLES.sql`
3. **–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –ü–†–û–ß–ò–¢–ê–ô–¢–ï** —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
4. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ email_verification_codes —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

**–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:** `database/README_APPLICATIONS.md` - –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ –±—ã–ª–∞ —Ç–∞–±–ª–∏—Ü–∞ applications

---

## 3. üìß Deploy Edge Function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ approval email

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:** `supabase/functions/send-approval-email/index.ts`

**–ö–∞–∫ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å:**

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase CLI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
supabase functions deploy send-approval-email
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase Dashboard
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí Edge Functions
2. –ù–∞–∂–º–∏—Ç–µ **New Function**
3. –ò–º—è: `send-approval-email`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ `supabase/functions/send-approval-email/index.ts`
5. Deploy

**–ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `RESEND_API_KEY` - –≤–∞—à API –∫–ª—é—á –æ—Ç Resend

---

## 4. üîí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç SQL/HTML –∏–Ω—ä–µ–∫—Ü–∏–π

**–ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ:** –§—É–Ω–∫—Ü–∏—è `sanitizeInput()` –≤ `src/utils/security.ts`

**–ù–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:**
- –£–¥–∞–ª–µ–Ω–∏–µ ALL HTML tags
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ SQL keywords (SELECT, INSERT, UPDATE, DELETE, DROP, etc.)
- –£–¥–∞–ª–µ–Ω–∏–µ javascript:, data:, vbscript: protocols
- –£–¥–∞–ª–µ–Ω–∏–µ SQL –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (--,  /*, */)

**–î–µ–π—Å—Ç–≤–∏—è:** –ù–∏—á–µ–≥–æ, —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –≤ –∫–æ–¥–µ.

---

## 5. üñºÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∞–≤–∞—Ç–∞—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º:**
1. **CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –≤ Supabase Storage
2. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –¥–ª—è bucket 'avatars'
3. **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞** > 5MB
4. **–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç** (—Ç–æ–ª—å–∫–æ JPEG, PNG, WebP)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**

### Supabase Dashboard ‚Üí Storage ‚Üí avatars:
1. **Policies:** –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
   ```sql
   CREATE POLICY "Public read access"
   ON storage.objects FOR SELECT
   USING (bucket_id = 'avatars');

   CREATE POLICY "Authenticated users can upload"
   ON storage.objects FOR INSERT
   WITH CHECK (bucket_id = 'avatars' AND auth.role() = 'authenticated');
   ```

2. **CORS:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Å –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞

3. **Public bucket:** –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω Public access

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–¥–µ:
–§–∞–π–ª: `src/stores/auth.ts:441-467`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç MIME type –∏ —Ä–∞–∑–º–µ—Ä
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
- –ü–æ–ª—É—á–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL

---

## 6. üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. –ó–∞–π—Ç–∏ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å `/admin`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è email –ø—Ä–∏ –∞–ø—Ä—É–≤–µ

---

## 7. ‚ö†Ô∏è password_hash - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ü–æ—á–µ–º—É password_hash –ø—É—Å—Ç–æ–π –≤ –ë–î:**

–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Supabase Auth**, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç –ø–∞—Ä–æ–ª–∏ –≤ —Å–≤–æ–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–∞–±–ª–∏—Ü–µ `auth.users`.

**password_hash –≤ users —Ç–∞–±–ª–∏—Ü–µ:**
- –ü—É—Å—Ç–æ–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
- –ó–∞–ø–æ–ª–Ω–µ–Ω –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
- –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ –µ—Å–ª–∏ –≤—Å–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã

**–ù–µ —É–¥–∞–ª—è–π—Ç–µ password_hash –µ—Å–ª–∏:**
- –ï—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–∞—Ä–æ–ª—è–º–∏ bcrypt
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ç–∞—Ä—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ Email verification —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –õ–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
‚úÖ –ê–ø—Ä—É–≤/–†–µ–¥–∂–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email
‚úÖ –ê–≤–∞—Ç–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "infinite recursion"
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "get_pending_applications_for_admin"
‚úÖ Yandex Maps –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è approved –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard ‚Üí Logs
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Edge Function –∑–∞–¥–µ–ø–ª–æ–µ–Ω–∞
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## –†–µ–∑—é–º–µ

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:**
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å PRODUCTION_SECURE_RLS_FIXED.sql
2. ‚úÖ Deploy send-approval-email Edge Function

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å CLEANUP_UNUSED_TABLES.sql
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Storage policies –¥–ª—è avatars

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:**
1. –£–¥–∞–ª–∏—Ç—å email_verification_codes (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)
2. –£–¥–∞–ª–∏—Ç—å password_hash –ø–æ–ª–µ (–µ—Å–ª–∏ –≤—Å–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã)

---

**–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ!**
