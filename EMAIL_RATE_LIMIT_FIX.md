# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã Email Rate Limit

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –æ—à–∏–±–∫—É **"Email rate limit exceeded"** –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. **Supabase Auth** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ `signUp()`
2. **–ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ç–æ—Ä–æ–µ –ø–∏—Å—å–º–æ —Å 6-–∑–Ω–∞—á–Ω—ã–º –∫–æ–¥–æ–º
3. **–ò—Ç–æ–≥–æ**: 2 –ø–∏—Å—å–º–∞ –Ω–∞ –æ–¥–Ω—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

Supabase –∏–º–µ–µ—Ç —Å—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç: **3-4 –ø–∏—Å—å–º–∞ –≤ —á–∞—Å** –Ω–∞ –æ–¥–∏–Ω email –∞–¥—Ä–µ—Å.

## –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–ª—é—á–∏—Ç—å Email Confirmation –≤ Supabase (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–í Supabase Dashboard:**

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Authentication** ‚Üí **Email Templates**
2. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –¥–æ **Settings**
3. –ù–∞–π–¥–∏—Ç–µ –æ–ø—Ü–∏—é **"Enable email confirmations"**
4. **–°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É** (–æ—Ç–∫–ª—é—á–∏—Ç–µ)

–≠—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å–µ–º –æ—Ç Supabase Auth, –∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–¥—ã.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –†–µ–∂–∏–º –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`:

```bash
VITE_DISABLE_EMAIL=true
```

–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ:
- Email **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** —Ä–µ–∞–ª—å–Ω–æ
- –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è **–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏** –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

**–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**

```bash
# –í —Ñ–∞–π–ª–µ .env
VITE_DISABLE_EMAIL=true

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä
npm run dev
```

**–ì–¥–µ –Ω–∞–π—Ç–∏ –∫–æ–¥:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–≤–∏–¥–∏—Ç–µ:
```
============================================================
üìß DEV MODE: Email sending disabled
üì® Email: user@example.com
üî¢ Verification Code: 123456
‚è∞ Expires in: 15 minutes
============================================================
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π SMTP –°–µ—Ä–≤–µ—Ä

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Supabase:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤:
   - **SendGrid** (100 –ø–∏—Å–µ–º/–¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
   - **Mailgun** (5000 –ø–∏—Å–µ–º/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
   - **Resend** (3000 –ø–∏—Å–µ–º/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ)

2. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á

3. –û–±–Ω–æ–≤–∏—Ç–µ Supabase Edge Function `send-verification-email`:

```typescript
// supabase/functions/send-verification-email/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  const { email, code } = await req.json()

  // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à SMTP —Å–µ—Ä–≤–∏—Å
  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${Deno.env.get('SENDGRID_API_KEY')}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      personalizations: [{
        to: [{ email }],
        subject: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è TourFurr'
      }],
      from: { email: 'noreply@tourfurr.ru' },
      content: [{
        type: 'text/plain',
        value: `–í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${code}\n\n–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 15 –º–∏–Ω—É—Ç.`
      }]
    })
  })

  return new Response(JSON.stringify({ success: response.ok }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

## –¢–µ–∫—É—â–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

‚úÖ **–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –∫–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ Rate Limit**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
‚úÖ **Grace Period**: 15 –º–∏–Ω—É—Ç –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
‚úÖ **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –µ—Å–ª–∏ –ø–∏—Å—å–º–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**:
   - Supabase Auth: ~~–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email~~ (–µ—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
   - –ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ (–∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏ –≤ dev —Ä–µ–∂–∏–º–µ)

2. **Dev —Ä–µ–∂–∏–º** (`VITE_DISABLE_EMAIL=true`):
   - –ö–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
   - –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π rate limit

3. **Production** (—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º SMTP):
   - –†–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Edge Function
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ rate limit
   - –ü–æ–∫–∞–∑ –ø–æ–Ω—è—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†–µ–∂–∏–º –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "VITE_DISABLE_EMAIL=true" >> .env

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server
npm run dev

# 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç–µ

# 4. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) ‚Üí Console

# 5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏

# 6. –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
```

### 2. Production —Å Supabase Email Disabled

1. –í Supabase Dashboard –æ—Ç–∫–ª—é—á–∏—Ç–µ "Enable email confirmations"
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Edge Function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
3. –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Grace Period

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å
2. –ó–∞–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ `/auth/verify-email?email=YOUR_EMAIL`
4. –£–≤–∏–¥–∏—Ç–µ —Ç–∞–π–º–µ—Ä —Å –æ—Å—Ç–∞–≤—à–∏–º—Å—è –≤—Ä–µ–º–µ–Ω–µ–º (15:00)
5. –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω

## FAQ

**Q: –ü–æ—á–µ–º—É —è –≤—Å–µ –µ—â–µ –ø–æ–ª—É—á–∞—é rate limit?**
A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤ Supabase Dashboard –æ—Ç–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è "Enable email confirmations"

**Q: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ dev —Ä–µ–∂–∏–º–µ?**
A: Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –∫–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π email —Å–µ—Ä–≤–∏—Å?**
A: –î–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Edge Function —Å –≤–∞—à–∏–º SMTP –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º (SendGrid, Mailgun, etc)

**Q: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –µ—Å–ª–∏ –ø–∏—Å—å–º–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å?**
A: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ —á–µ—Ä–µ–∑ "Resend Code"

**Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ?**
A: 15 –º–∏–Ω—É—Ç (grace period), –ø–æ—Å–ª–µ —á–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –£–≤–µ–ª–∏—á–∏—Ç—å Grace Period

–í —Ñ–∞–π–ª–µ `src/utils/gracePeriod.ts`:

```typescript
// –ò–∑–º–µ–Ω–∏—Ç—å —Å 15 –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
export const GRACE_PERIOD_MINUTES = 30
```

–ò –≤ SQL —Ñ—É–Ω–∫—Ü–∏–∏ `database/cleanup_unverified_accounts.sql`:

```sql
-- –ò–∑–º–µ–Ω–∏—Ç—å grace_period_minutes
grace_period_minutes INTEGER := 30;
```

### –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞

–í —Ñ–∞–π–ª–µ `src/utils/emailVerification.ts`:

```typescript
// –ò–∑–º–µ–Ω–∏—Ç—å —Å 15 –º–∏–Ω—É—Ç –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
const expiresAt = new Date(Date.now() + 30 * 60 * 1000) // 30 –º–∏–Ω—É—Ç
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å email –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Supabase Dashboard:
1. **Edge Functions** ‚Üí Logs
2. **Authentication** ‚Üí Logs
3. –§–∏–ª—å—Ç—Ä –ø–æ email –∞–¥—Ä–µ—Å—É

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limit –¥–ª—è email:
```sql
-- –í SQL Editor
SELECT * FROM auth.audit_log_entries
WHERE event_message LIKE '%rate limit%'
ORDER BY created_at DESC
LIMIT 10;
```
