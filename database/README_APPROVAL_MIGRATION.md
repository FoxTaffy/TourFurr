# Миграция: Ограничение доступа к апруву заявок

## Описание изменений

Эта миграция добавляет функционал ограничения доступа к апруву заявок только для определенных пользователей (Алар, Кеса, Диеро) и добавляет статус "отложенные" для заявок.

### Что изменено:

1. **База данных:**
   - Добавлено поле `can_approve_applications` в таблицу `users`
   - Добавлен статус `deferred` (отложенные) в таблицу `applications`

2. **Frontend (Vue.js):**
   - Обновлен интерфейс `User` с полем `canApproveApplications`
   - Обновлен компонент `ApplicationsManagement.vue`:
     - Добавлена кнопка "Отложить" для заявок со статусом `pending`
     - Добавлен фильтр и статистика для отложенных заявок
     - Добавлена проверка прав доступа для кнопок апрува
     - Показывается предупреждение для пользователей без прав апрува
   - Обновлен компонент `DashboardPage.vue`:
     - Добавлен статус `deferred` (отображается как "На рассмотрении")
     - Обновлены описания статусов с текстом о возможности знакомства с оргами

3. **Backend (Supabase Edge Functions):**
   - Обновлена функция `send-approval-email`:
     - Изменен текст отказа на более прямой
     - Добавлена ссылка на контакты организаторов

## Инструкции по применению миграции

### Шаг 1: Применить миграцию БД

Выполните SQL-скрипт в Supabase SQL Editor:

```bash
database/add_approval_permissions_and_deferred_status.sql
```

### Шаг 2: Назначить права апрува

После применения миграции необходимо назначить права апрува для трех пользователей: Алар, Кеса и Диеро.

Выполните следующий SQL-запрос в Supabase SQL Editor, заменив email-адреса на реальные:

```sql
UPDATE users
SET can_approve_applications = true
WHERE email IN (
  'alar_email@example.com',  -- Заменить на реальный email Алара
  'kesa_email@example.com',  -- Заменить на реальный email Кесы
  'diero_email@example.com'  -- Заменить на реальный email Диеро
);
```

### Шаг 3: Проверить применение миграции

Проверьте, что миграция применилась успешно:

```sql
-- Проверить добавление поля can_approve_applications
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'users' AND column_name = 'can_approve_applications';

-- Проверить обновление constraint для applications.status
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name LIKE '%status_check%';

-- Проверить пользователей с правами апрува
SELECT id, email, nickname, can_approve_applications
FROM users
WHERE can_approve_applications = true;
```

### Шаг 4: Развернуть обновленную Edge Function

Разверните обновленную функцию `send-approval-email`:

```bash
cd supabase
supabase functions deploy send-approval-email
```

## Функциональность после миграции

### Для администраторов с правами апрува (Алар, Кеса, Диеро):

- Могут просматривать все заявки во вкладке "Заявки на участие"
- Могут одобрять, отклонять и откладывать заявки
- Видят отдельную статистику и фильтр для отложенных заявок
- Могут работать с отложенными заявками (одобрить, отклонить, в лист ожидания)

### Для других администраторов (без прав апрува):

- Могут просматривать все заявки во вкладке "Заявки на участие"
- Видят предупреждение: "У вас нет прав для одобрения заявок. Только Алар, Кеса и Диеро могут управлять заявками."
- Не могут изменять статус заявок

### Для участников:

- Со статусом `pending` или `deferred` видят сообщение:
  "Ваша заявка на рассмотрении. Вы получите уведомление на почту, когда статус изменится. Если Вы ранее не были на ТурФурр - админ может написать вам для знакомства."
- При отклонении заявки получают email с текстом:
  "К сожалению, Вам отказано в участии. Если вы не согласны с решением, пожалуйста, напишите одному из организаторов в контактах на сайте."

## Логика работы со статусами

### Статус "pending" (На рассмотрении):
- Начальный статус для всех новых заявок
- Показывается участнику как "На рассмотрении"
- Админы с правами апрува видят кнопки: "Одобрить", "Отложить", "Отклонить"

### Статус "deferred" (Отложенные):
- Используется для заявок, которые нужно рассмотреть позже
- Показывается участнику как "На рассмотрении" (участник не видит разницу)
- Email участнику НЕ отправляется при переводе в статус "deferred"
- Есть отдельный фильтр и счетчик в админ-панели
- Админы с правами апрува видят кнопки: "Одобрить", "В лист ожидания", "Отклонить"
- Используется для того, чтобы сначала апрувать "своих" людей из Google таблицы, а потом работать с остальными

### Workflow для оргов:

1. Получаем новую заявку (статус `pending`)
2. Сверяем имя/никнейм с Google таблицей приглашенных
3. Если в списке - сразу "Одобрить"
4. Если не в списке - нажать "Отложить" (переводит в статус `deferred`)
5. После того как все приоритетные заявки одобрены, переходим во вкладку "Отложенные"
6. Рассматриваем отложенные заявки по мере наличия свободных мест

## Откат миграции

Если необходимо откатить изменения:

```sql
-- Удалить поле can_approve_applications
ALTER TABLE users DROP COLUMN IF EXISTS can_approve_applications;

-- Откатить constraint для applications.status (убрать 'deferred')
ALTER TABLE applications DROP CONSTRAINT IF EXISTS applications_status_check;
ALTER TABLE applications ADD CONSTRAINT applications_status_check
  CHECK (status IN ('pending', 'approved', 'rejected', 'waitlist'));
```

⚠️ **Внимание:** Откат приведет к потере данных о правах апрува и все заявки со статусом `deferred` нужно будет вручную перевести в другой статус перед откатом.

## Контакты

При возникновении вопросов или проблем с миграцией, обратитесь к разработчику или в репозиторий проекта.
