### Test Password Reset Edge Functions
### Use with REST Client extension in VS Code or similar tools

### Variables
@supabase_url = https://plugjsubjcfblzkabjja.supabase.co
@anon_key = YOUR_ANON_KEY_HERE

### 1. Test send-password-reset-email
POST {{supabase_url}}/functions/v1/send-password-reset-email
Content-Type: application/json
Authorization: Bearer {{anon_key}}

{
  "email": "test@example.com",
  "code": "123456"
}

### Expected Response (Success):
# {
#   "success": true,
#   "messageId": "some-resend-message-id"
# }

### Expected Response (Rate Limit):
# {
#   "error": "Email rate limit exceeded",
#   "message": "Too many emails sent. Please wait and try again later."
# }


### 2. Test update-password
POST {{supabase_url}}/functions/v1/update-password
Content-Type: application/json
Authorization: Bearer {{anon_key}}

{
  "email": "existing-user@example.com",
  "newPassword": "NewSecurePassword123!"
}

### Expected Response (Success):
# {
#   "success": true,
#   "message": "Password updated successfully"
# }

### Expected Response (User Not Found):
# {
#   "success": false,
#   "error": "User not found"
# }

### Expected Response (Invalid Password):
# {
#   "success": false,
#   "error": "Password must be at least 8 characters"
# }


### 3. Test with invalid email format
POST {{supabase_url}}/functions/v1/send-password-reset-email
Content-Type: application/json
Authorization: Bearer {{anon_key}}

{
  "email": "invalid-email",
  "code": "123456"
}

### Expected Response:
# {
#   "error": "Invalid email format"
# }


### 4. Test with invalid code format
POST {{supabase_url}}/functions/v1/send-password-reset-email
Content-Type: application/json
Authorization: Bearer {{anon_key}}

{
  "email": "test@example.com",
  "code": "12345"
}

### Expected Response:
# {
#   "error": "Invalid code format"
# }


### 5. Test missing parameters
POST {{supabase_url}}/functions/v1/update-password
Content-Type: application/json
Authorization: Bearer {{anon_key}}

{
  "email": "test@example.com"
}

### Expected Response:
# {
#   "success": false,
#   "error": "Email and new password are required"
# }


###############################################
### SQL Queries for Testing
###############################################

### Check password_reset_codes table
# SELECT * FROM password_reset_codes
# WHERE email = 'test@example.com'
# ORDER BY created_at DESC;

### Check active codes
# SELECT email, code, created_at, expires_at, attempts, used
# FROM password_reset_codes
# WHERE used = false AND expires_at > NOW()
# ORDER BY created_at DESC;

### Manually create a test code
# INSERT INTO password_reset_codes (email, code, expires_at)
# VALUES ('test@example.com', '999999', NOW() + INTERVAL '15 minutes');

### Mark code as used
# UPDATE password_reset_codes
# SET used = true, verified_at = NOW()
# WHERE email = 'test@example.com' AND code = '999999';

### Clean up test data
# DELETE FROM password_reset_codes
# WHERE email LIKE '%test%' OR email LIKE '%example.com';

### Test cleanup function
# SELECT cleanup_expired_reset_codes();

### Check RLS policies
# SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
# FROM pg_policies
# WHERE tablename = 'password_reset_codes';


###############################################
### CURL Examples
###############################################

### Send password reset email
# curl -X POST "{{supabase_url}}/functions/v1/send-password-reset-email" \
#   -H "Authorization: Bearer {{anon_key}}" \
#   -H "Content-Type: application/json" \
#   -d '{"email": "test@example.com", "code": "123456"}'

### Update password
# curl -X POST "{{supabase_url}}/functions/v1/update-password" \
#   -H "Authorization: Bearer {{anon_key}}" \
#   -H "Content-Type: application/json" \
#   -d '{"email": "test@example.com", "newPassword": "NewPassword123!"}'


###############################################
### JavaScript/Browser Console Test
###############################################

### Test from browser console on your site
/*
// Test send-password-reset-email
const { data, error } = await supabase.functions.invoke('send-password-reset-email', {
  body: {
    email: 'test@example.com',
    code: '123456'
  }
});
console.log('Result:', data, error);

// Test update-password
const { data: updateData, error: updateError } = await supabase.functions.invoke('update-password', {
  body: {
    email: 'test@example.com',
    newPassword: 'NewPassword123!'
  }
});
console.log('Result:', updateData, updateError);

// Test full flow from utils
import { createPasswordResetCode, sendPasswordResetEmail, verifyResetCode } from './utils/passwordReset';

// 1. Create code
const result = await createPasswordResetCode('test@example.com');
console.log('Code created:', result);

// 2. Send email
if (result.code) {
  const sendResult = await sendPasswordResetEmail('test@example.com', result.code);
  console.log('Email sent:', sendResult);
}

// 3. Verify code
const verifyResult = await verifyResetCode('test@example.com', '123456');
console.log('Code verified:', verifyResult);
*/
